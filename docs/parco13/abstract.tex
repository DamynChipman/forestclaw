% PLEASE USE THIS FILE AS A TEMPLATE FOR THE PUBLICATION
% Check file IOS-Book-Article.tex


% preferred topic area: algorithms
% 
% at most 5 keywords
% 
% relevance
% 
% originality


\documentclass{IOS-Book-Article}     %[seceqn,secfloat,secthm]

\usepackage{mathptmx}
%\usepackage[T1]{fontenc}
%\usepackage{times}%
%
%%%%%%%%%%% Put your definitions here

\usepackage{amsmath,amssymb}
\usepackage{cite}
\usepackage{color}
\usepackage{xspace}

\newcommand{\todo}[1]{\textcolor{red}{[TODO: #1]}\xspace}
\newcommand{\sR}{\mathbb{R}}

%%%%%%%%%%% End of definitions
\begin{document}
\begin{frontmatter}          % The preamble begins here.
%
%\pretitle{}
\title{ForestClaw:
        Hybrid forest-of-octrees AMR for hyperbolic conservation laws}
\runningtitle{ForestClaw}
%\subtitle{}

% Two or more authors:
%\author[A]{\fnms{} \snm{}},
%\author[B]{\fnms{} \snm{}}
%\runningauthor{}
%\address[A]{}
%\address[B]{}
%
\author[A]{\fnms{Carsten} \snm{Burstedde}%
\thanks{Corresponding author.  E-mail: \texttt{burstedde@ins.uni-bonn.de}}},
\author[B]{\fnms{Donna} \snm{Calhoun}},
\author[C]{\fnms{Kyle} \snm{Mandli}} and
\author[C]{\fnms{Andy R.} \snm{Terrel}}
\runningauthor{C.\ Burstedde et.al.}
\address[A]{Institut f\"ur Numerische Simulation, Universit\"at Bonn, Germany}
\address[B]{Boise State University, Idaho, USA}
\address[C]{Institute for Computational Engineering and Sciences,\\
The University of Texas at Austin, USA}

\begin{abstract}
%
We present a new hybrid paradigm for parallel adaptive mesh refinement (AMR)
that combines the scalability and lightweight architecture of tree-based AMR
with the computational efficiency of patch-based solvers for hyperbolic
conservation laws.  The key idea is to interpret each leaf of the AMR hierarchy
as one uniform compute patch in $\sR^d$ of dimensions $m^d$, where $m$ is
customarily between 8 and 32.  Thus, computation on each patch can be optimized
for speed, while we inherit the flexibility of adaptive meshes.  In our work we
choose to work with the p4est AMR library since it allows to compose the mesh
from multiple mapped octrees, thus enabling the cubed sphere and other
nontrivial multiblock geometries.
%
\end{abstract}

% \begin{keyword}
% adaptive mesh refinement,
% clawpack,
% HPC,
% manycore
% \end{keyword}

\end{frontmatter}

%%%%%%%%%%% The article body starts:

\section*{Introduction}

With the advent of high-throughput coprocessors, such as GPGPUs or the MIC
chip, comes the opportunity to sustain unprecedented rates of floating point
operations at comparably high integration density and low cost.  These
architectures, however, require careful structuring of the data layout and
memory access patterns to exhaust their multithreading and vectorization
capabilities.

Consequently, it is not clear a priori how to accelerate PDE solvers that use
adaptive mesh refinement, especially when working with unstructured meshes.  Of
course, it has been realized early that it helps to aggregate degrees of
freedom (DOF) at the element level, as it has been done with high-order
spectral element \cite{TufoFischer99}, finite volume
\todo{add favorite citation}, or discontinuous Galerkin
\cite{BursteddeGhattasGurnisEtAl10} methods.
%
% For example, SEs optimized for computational speed have originally been
% implemented on unstructured conforming meshes \cite{TufoFischer99} and later
% been extended to non-conforming adaptive meshes \cite{FischerKruseLoth02,
% BursteddeGhattasGurnisEtAl10}.

To enable hardware acceleration for parallel dynamic AMR, we like to build upon
the forest-of-octrees paradigm because of its low overhead and proven
scalability \cite{BursteddeWilcoxGhattas11}.  As an important extension, we go
beyond the traditional high-order element and define each mesh element to be a
dense compute patch with $m^d$ DOFs.  In fact, this approach resembles
block-structured AMR \cite{ColellaGravesKeenEtAl07}
\todo{favorite BoxLib citation}
except that the patches are not overlapping, which enables us to capitalize on
our previous experience with scalable FE solvers for PDEs
\cite{BursteddeStadlerAlisicEtAl13}.  A particular implementation of such a
patch is available with the Clawpack software \cite{LeVeque97} that has been
designed to solve hyperbolic conservation laws on a uniform compute patch and
successfully used in the context of block-structured AMR \todo{AMRClaw
citation}.

In this paper we describe how we design the coupling of forest-of-octree AMR
with Clawpack at the leaf level.  We comment on challenges that arise in
enabling efficient parallelism and multiblock geometries and close with a range
of numerical examples that demonstrate the conceptual improvements in relation
to other approaches.

\section*{Design principles}

The starting point of our work is defined by the p4est algorithms for
forest-of-octrees AMR on the one hand, and the Clawpack algorithms for the
numerical solution of hyperbolic conservation laws
% on uniformly gridded domains
on the other.  Both are specialized codes with the following characteristics:
\begin{center}
\begin{tabular}{l|l|l}
& \multicolumn{1}{c|}{\texttt{p4est}} & \multicolumn{1}{c}{Clawpack} \\
\hline
subject & hexahedral nonconforming mesh &  hyperbolic PDE on $[0, 1]^d$ \\
structure & forest of octrees & patch of $m^d$ DOFs \\
atomic unit & octree leaf & one DOF \\
parallelization & MPI & threads \\
memory access & distributed & shared \\
data type & integers & floating point values \\
language & C & Fortran 77 \\
dependencies & none & Python \\
\hline
\end{tabular}
\end{center}
The proposed 1:1 correspondence between a leaf and a patch thus combines two
hithertwo disjoint models in a modular way that permits the reuse of existing,
verified and performant codes if the integration is done well.  The resulting
parallel programming model is a hybrid and often referred to as MPI+X.

Multiblock handling
generic transformations
yields periodicity as a special case

Identification: an octree is a block, and a leaf is a patch.

Each block is understood as a reference unit cube with an optional per-block
geometric mapping.  The coordinate system of 


Information provided by the mesh:
Sequence of blocks, list of patches for each.  Each patch
has a list of neighbor patches including information on 


AMR Metadata $\ll$ numerical data


Experience from integration with large-scale adaptive-mesh PDE solvers.
Design goals: Lightweight, modular, reuse.

Separation of mesh on the one hand from discretization and solvers on the other.

Mesh information is discrete (tree nodes have integer coordinates in
$(0, 2^L($ where $L$ is the maximum allowed refinement level of the tree.

sorted ordering of tree nodes, lookup tables, .

Dimension independence


rank as is common with parallelization using the MPI framework
%\cite{Forum94, SnirOttoHuss-LedermanEtAl96}.

Challenge: patch neighborhood information is known to the mesh backend
but needs to be used to handle ghost information.



\section*{Hybrid forest-of-octrees AMR}


$z$-order

Iterators over all leafs, optionally restricted to a given level.
Random access is possible.  Looping over the patches in the order prescribed
by the forest leads to a high percentage of cache reuse, since the ghost
patches are likely closeby with respect to the $z$-order.


same block, same rank: local copy.

neighbor block: permutation of patch points due to non-aligned
coordinate systems

neighbor rank: data needs to be fetched over the network first.

Trees have different coordinate systems.

$L$ is 30 for 2D and 19 for 3D, so it allows for deep hierarchies.

fast (O(log N/P)) neighbor and parent/child lookups
horizontal/vertical tree traversal


subcycling: level-wise load balancing as done in structured AMR or
geometric adaptive multigrid \cite{SundarBirosBursteddeEtAl12}


\todo{What is BearClaw (tree-based / S.\ Mitran)?}


\section*{Patch-based numerics at the leaf level}


Patch: contains the local coordinates and copies of neighboring ghost degrees
of freedom.  The layer of ghost copies is usually 2 points deep.


\section*{Numerical results}



\section*{Acknowledgements}

The authors acknowledge valuable discussion with Randy LeVeque, Marsha Berger,
and Hans-Petter Langtangen.  The leaf/grid paradigm was independently presented
by B.\ as part of a talk at the SCI Institute, Utah, in July 2011.


%%%%%%%%%%% The bibliography starts:
\bibliographystyle{unsrt}
\bibliography{ccgo}

\end{document}
