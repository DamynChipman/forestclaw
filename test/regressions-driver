#! /bin/sh
# test-driver - basic testsuite driver script.
# modified test-driver from automake by Scott Aiton for doctest

scriptversion=2018-03-07.03; # UTC

# Copyright (C) 2011-2018 Free Software Foundation, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# As a special exception to the GNU General Public License, if you
# distribute this file as part of a program that contains a
# configuration script generated by Autoconf, you may include it under
# the same distribution terms that you use for the rest of that program.

# Make unconditional expansion of undefined variables an error.  This
# helps a lot in preventing typo-related bugs.
set -u

usage_error ()
{
  echo "$0: $*" >&2
  print_usage >&2
  exit 2
}

print_usage ()
{
  cat <<END
Usage:
  test-driver --test-name=NAME --log-file=PATH --trs-file=PATH
              [--expect-failure={yes|no}] [--color-tests={yes|no}]
              [--enable-hard-errors={yes|no}] [--]
              TEST-SCRIPT [TEST-SCRIPT-ARGUMENTS]
The '--test-name', '--log-file' and '--trs-file' options are mandatory.
END
}

test_name= # Used for reporting.
log_file=  # Where to save the output of the test script.
trs_file=  # Where to save the metadata of the test run.
expect_failure=no
color_tests=no
enable_hard_errors=yes
while test $# -gt 0; do
  case $1 in
  --help) print_usage; exit $?;;
  --version) echo "test-driver $scriptversion"; exit $?;;
  --test-name) test_name=$2; shift;;
  --log-file) log_file=$2; shift;;
  --trs-file) trs_file=$2; shift;;
  --color-tests) color_tests=$2; shift;;
  --expect-failure) expect_failure=$2; shift;;
  --enable-hard-errors) enable_hard_errors=$2; shift;;
  --) shift; break;;
  -*) usage_error "invalid option: '$1'";;
   *) break;;
  esac
  shift
done

missing_opts=
test x"$test_name" = x && missing_opts="$missing_opts --test-name"
test x"$log_file"  = x && missing_opts="$missing_opts --log-file"
test x"$trs_file"  = x && missing_opts="$missing_opts --trs-file"
if test x"$missing_opts" != x; then
  usage_error "the following mandatory options are missing:$missing_opts"
fi

if test $# -eq 0; then
  usage_error "missing argument"
fi

if test $color_tests = yes; then
  # Keep this in sync with 'lib/am/check.am:$(am__tty_colors)'.
  red='[0;31m' # Red.
  grn='[0;32m' # Green.
  lgn='[1;32m' # Light green.
  blu='[1;34m' # Blue.
  mgn='[0;35m' # Magenta.
  std='[m'     # No color.
else
  red= grn= lgn= blu= mgn= std=
fi

do_exit='rm -f $log_file $trs_file; (exit $st); exit $st'
trap "st=129; $do_exit" 1
trap "st=130; $do_exit" 2
trap "st=141; $do_exit" 13
trap "st=143; $do_exit" 15

IFS='
'
a_test_failed=no

# resolve paths of FCLAW_SRC_DIR and FCLAW_BUILD_DIR since they may be relative
# to the current working directory
FCLAW_SRC_DIR=`cd $FCLAW_SRC_DIR; pwd`
FCLAW_BUILD_DIR=`cd $FCLAW_BUILD_DIR; pwd`

# resolve full paths
regressions=`pwd`/$@
log_file=$FCLAW_BUILD_DIR/$log_file
trs_file=$FCLAW_BUILD_DIR/$trs_file

# change directory to source directory of regression
cd `dirname $@`

error=$?
if test $error -eq 0; then
  #read regression.txt file line by line
  while IFS= read -r line
  do
    # strip leading "line: "
    line=`echo $line | sed -e "s|^line: ||"`
    # strip leading and trailing whitespace
    line=`echo $line | sed -e "s|^[ \t]*||" -e "s|[ \t]*$||"`

    # if line starts with "#" skip
    if test x"`echo $line | cut -c1-1`" = x"#"; then
      continue
    fi

    # if empty line, skip
    if test x"$line" = x; then
      continue
    fi

    # if line starts with "cd " execute line
    if test x"`echo $line | cut -c1-3`" = x"cd "; then
      `$line`
      continue
    fi

    # the directory relative to applications
    # remove FCLAW_SRC_DIR from the beginning of the path
    relative_dir=`pwd | sed -e "s|^$FCLAW_SRC_DIR||"`
    # remove leading slash
    relative_dir=`echo $relative_dir | sed -e "s|^/applications/||"`


    # test name to show to console and logs
    test_name="$relative_dir: $line"
    # full command to execute
    full_cmd="$FCLAW_BUILD_DIR/applications/$relative_dir/$line"
  
    # Individual test cases run here
    echo "$test_name" >> $log_file
  
    eval "$full_cmd" >> $log_file 2>&1
    estatus=$?
    
    #doctest only has pass/fail state
    #expect_failure means at least one of the tests should fail
    case $estatus:$expect_failure in
      0:*)   col=$grn res=PASS                   ;;
      *:yes) col=$lgn res=XFAIL a_test_failed=yes;;
      *:*)   col=$red res=FAIL  a_test_failed=yes;;
    esac
    
    # Report the test outcome and exit status in the logs, so that one can
    # know whether the test passed or failed simply by looking at the '.log'
    # file, without the need of also peaking into the corresponding '.trs'
    # file (automake bug#11814).
    echo "$res $test_name (exit status: $estatus)" >> $log_file
    echo >> $log_file
    
    # Report outcome to console.
    echo "${col}${res}${std}: ${test_name}"
    
    # Register the test result, and other relevant metadata.
    echo ":test-result: $res ${test_name}" >> $trs_file
  
  done < "$regressions"
fi

# the global test result can be pass/fail/xpass/xfail
case $error:$a_test_failed:$expect_failure in
  0:no:yes)  col=$red  res=XPASS recheck=yes gcopy=yes;;
  0:no:no)   col=$grn  res=PASS  recheck=no  gcopy=no ;;
  0:yes:yes) col=$lgn  res=XFAIL recheck=no  gcopy=yes;;
  0:yes:no)  col=$red  res=FAIL  recheck=yes gcopy=yes;;
  *:*:*)     col=$mgn  res=ERROR recheck=yes gcopy=yes;;
esac

if test "$res" = "XPASS"; then
    echo ":test-result: $res ${test_name}" >> $trs_file
    echo "${col}${res}${std}: ${test_name}"
fi

if test "$res" = "ERROR"; then
    echo ":test-result: $res ${test_name}" >> $trs_file
    echo "${col}${res}${std}: ${test_name}"
fi



echo ":global-test-result: $res ${test_name}" >> $trs_file
echo ":recheck: $recheck" >> $trs_file
echo ":copy-in-global-log: $gcopy" >> $trs_file
